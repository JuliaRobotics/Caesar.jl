<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Building Factor Graphs · Caesar.jl</title><link href="https://fonts.googleapis.com/css?family=Lato|Roboto+Mono" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.11.1/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit">Caesar.jl</span></div><form class="docs-search" action="../../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../../">Introduction</a></li><li><span class="tocitem">Welcome</span><ul><li><a class="tocitem" href="../../installation_environment/">Installation</a></li><li><a class="tocitem" href="../../faq/">FAQ</a></li></ul></li><li><span class="tocitem">Getting Started</span><ul><li><a class="tocitem" href="../concepts/">Initial Concepts</a></li><li class="is-active"><a class="tocitem" href>Building Factor Graphs</a><ul class="internal"><li><a class="tocitem" href="#What-are-Variables-and-Factors"><span>What are Variables and Factors</span></a></li><li class="toplevel"><a class="tocitem" href="#Julia-and-Help"><span>Julia and Help</span></a></li><li><a class="tocitem" href="#Loading-Packages"><span>Loading Packages</span></a></li><li><a class="tocitem" href="#Familiarize-with-Canonical-Factor-Graphs"><span>Familiarize with Canonical Factor Graphs</span></a></li><li><a class="tocitem" href="#Building-a-new-Graph"><span>Building a new Graph</span></a></li><li><a class="tocitem" href="#Variables"><span>Variables</span></a></li><li><a class="tocitem" href="#Factors"><span>Factors</span></a></li><li><a class="tocitem" href="#When-to-Instantiate-Poses-(i.e.-new-Variables-in-Factor-Graph)"><span>When to Instantiate Poses (i.e. new Variables in Factor Graph)</span></a></li><li><a class="tocitem" href="#Which-Variables-and-Factors-to-use"><span>Which Variables and Factors to use</span></a></li></ul></li><li><a class="tocitem" href="../interacting_fgs/">Solving and Interacting</a></li><li><a class="tocitem" href="../dataassociation/">Multi-Modal/Hypothesis</a></li><li><a class="tocitem" href="../available_varfacs/">Internal Variables/Factors</a></li><li><a class="tocitem" href="../entry_data/">Entry=&gt;Data Blob</a></li><li><a class="tocitem" href="../2d_plotting/">Plotting (2D)</a></li><li><a class="tocitem" href="../multilang/">Multi-Language Support</a></li><li><a class="tocitem" href="../database_interactions/">Cloud Server/Database</a></li><li><a class="tocitem" href="../multisession/">Multi-session/agent Solving</a></li><li><a class="tocitem" href="../arena_visualizations/">Visualization (3D)</a></li></ul></li><li><span class="tocitem">Examples</span><ul><li><a class="tocitem" href="../../examples/examples/">Caesar Examples</a></li><li><a class="tocitem" href="../../examples/basic_continuousscalar/">ContinuousScalar as 1D Example</a></li><li><a class="tocitem" href="../../examples/basic_slamedonut/">Under-defined Trilateration, 2D</a></li><li><a class="tocitem" href="../../examples/basic_hexagonal2d/">Hexagonal 2D SLAM</a></li><li><a class="tocitem" href="../../examples/interm_fixedlag_hexagonal/">Fixed-Lag Solving 2D</a></li><li><a class="tocitem" href="../../examples/deadreckontether/">Dead Reckon Tether</a></li></ul></li><li><span class="tocitem">Principles</span><ul><li><a class="tocitem" href="../../principles/filterCorrespondence/">Filters vs. Graphs</a></li><li><a class="tocitem" href="../../principles/approxConvDensities/">Generic Convolutions</a></li><li><a class="tocitem" href="../../principles/multiplyingDensities/">Multiplying Functions (.py)</a></li><li><a class="tocitem" href="../../principles/bayestreePrinciples/">Bayes (Junction) tree</a></li><li><a class="tocitem" href="../../principles/initializingOnBayesTree/">Advanced Bayes Tree Topics</a></li><li><a class="tocitem" href="../mmisam_alg/">Multimodal iSAM Algorithm</a></li></ul></li><li><span class="tocitem">How to Expand?</span><ul><li><a class="tocitem" href="../adding_variables_factors/">Custom Variables and Factors</a></li><li><a class="tocitem" href="../../examples/basic_definingfactors/">Creating Variables and Factors</a></li><li><a class="tocitem" href="../../examples/interm_dynpose/">Creating DynPose Factor</a></li></ul></li><li><span class="tocitem">Developer Zone</span><ul><li><a class="tocitem" href="../../dev/wiki/">Wiki Pointers</a></li></ul></li><li><span class="tocitem">Literature</span><ul><li><a class="tocitem" href="../../refs/literature/">References</a></li></ul></li><li><span class="tocitem">Function Reference</span><ul><li><a class="tocitem" href="../../func_ref/">Caesar&#39;s Reference</a></li><li><a class="tocitem" href="../../vis_func_ref/">Visualization Reference</a></li></ul></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Getting Started</a></li><li class="is-active"><a href>Building Factor Graphs</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Building Factor Graphs</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/JuliaRobotics/Caesar.jl/blob/master/docs/src/concepts/building_graphs.md" title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="Building-and-Solving-Graphs"><a class="docs-heading-anchor" href="#Building-and-Solving-Graphs">Building and Solving Graphs</a><a id="Building-and-Solving-Graphs-1"></a><a class="docs-heading-anchor-permalink" href="#Building-and-Solving-Graphs" title="Permalink"></a></h1><p>Irrespective of your application - real-time robotics, batch processing of survey data, or really complex multi-hypothesis modeling - you&#39;re going to need to add factors and variables to a graph. This section discusses how to do that in Caesar.</p><p>The following sections discuss the steps required to construct a graph and solve it:</p><ul><li>Initialing the Factor Graph</li><li>Adding Variables and Factors to the Graph</li><li>Solving the Graph</li><li>Informing the Solver About Ready Data</li></ul><h2 id="What-are-Variables-and-Factors"><a class="docs-heading-anchor" href="#What-are-Variables-and-Factors">What are Variables and Factors</a><a id="What-are-Variables-and-Factors-1"></a><a class="docs-heading-anchor-permalink" href="#What-are-Variables-and-Factors" title="Permalink"></a></h2><p>Factor graphs are bipartite, i.e. variables and factors.  In practice we use &quot;nodes&quot; to represent both variables and factors with edges between.  In future, we will remove the wording &quot;node&quot; from anything Factor Graph usage/abstraction related (only vars and factors).  Nodes and edges will be used as terminology for actually storing the data on some graph storage/process foundation technology.</p><p>Even more meta – factors are &quot;variables&quot; that have already been observed and are now stochastically &quot;fixed&quot;.  Waving hands over the fact that a factors encode both the algebraic model AND the observed measurement values.</p><p>Variables in the factor graph have not been observed, but we want to back them out from the observed values and algebra relating them all.  If factors are constructed from statistically independent measurements (i.e. no direct correlations between measurements other than the algebra already connecting them), then we can use Probabilistic Chain rule to write inference operation down (unnormalized):</p><div>\[P(\Theta | Z)  =  P(Z | \Theta) P(\Theta)\]</div><p>where Theta represents all variables and Z represents all measurements or data, and</p><div>\[P(\Theta , Z) = P(Z | \Theta) P(\Theta)\]</div><p>or</p><div>\[P(\Theta, Z) = P(\Theta | Z) P(Z).\]</div><p>You&#39;ll notice the first looks like &quot;Bayes rule&quot; and we take <span>$P(Z)$</span> as a constant (the uncorrelated assumption).</p><h1 id="Julia-and-Help"><a class="docs-heading-anchor" href="#Julia-and-Help">Julia and Help</a><a id="Julia-and-Help-1"></a><a class="docs-heading-anchor-permalink" href="#Julia-and-Help" title="Permalink"></a></h1><p>The first thing in Julia is learning how to get the Help Documentation for a function, or finding any function in the first place.  When launching the REPL in a terminal or and IDE like VS Code (see link for documtation website):</p><pre><code class="language-bash">$ julia -O3
               _
   _       _ _(_)_     |  Documentation: https://docs.julialang.org
  (_)     | (_) (_)    |
   _ _   _| |_  __ _   |  Type &quot;?&quot; for help, &quot;]?&quot; for Pkg help.
  | | | | | | |/ _` |  |
  | | |_| | | | (_| |  |  Version 1.5.2 (2020-09-23)
 _/ |\__&#39;_|_|_|\__&#39;_|  |  Official https://julialang.org/ release
|__/                   |</code></pre><p>The <code>-O 3</code> is for level 3 code compilation optimization and is a useful habit for slightly faster execution, but slightly slower first run just-in-time compilation of any new function.</p><p>To get help with a function, just start with the <code>?</code> character followed by the function name, e.g.:</p><pre><code class="language-julia">?sin
# help?&gt; sin
search: sin sinh sind sinc sinpi sincos sincosd SingleThreaded SingularException asin using isinf asinh asind isinteger isinteractive

  sin(x)

  Compute sine of x, where x is in radians.

  ─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────

  sin(A::AbstractMatrix)

  Compute the matrix...</code></pre><h2 id="Loading-Packages"><a class="docs-heading-anchor" href="#Loading-Packages">Loading Packages</a><a id="Loading-Packages-1"></a><a class="docs-heading-anchor-permalink" href="#Loading-Packages" title="Permalink"></a></h2><p>Assuming you just loaded an empty REPL, or at the start of a script, or working inside the VSCode IDE, the first thing to do is load the necessary Julia packages.  Caesar.jl is an umbrella package potentially covering over 100 Julia Packages.  For this reason the particular parts of the code are broken up amongst more focussed <em>vertical purpose</em> library packages.  Usually for Robotics either <code>Caesar</code> or less expansive <code>RoME</code> will do.  Other non-Geometric sensor processing applications might build in the MM-iSAMv2, Bayes tree, and DistributedFactorGraph libraries.  Any of these packages can be loaded as follows:</p><pre><code class="language-julia"># umbrella containing most functional packages including RoME
using Caesar
# contains the IncrementalInference and other geometric manifold packages
using RoME
# contains among others DistributedFactorGraphs.jl and ApproxManifoldProducts.jl
using IncrementalInference</code></pre><h3 id="Requires.jl-for-Optional-Package-Loading"><a class="docs-heading-anchor" href="#Requires.jl-for-Optional-Package-Loading">Requires.jl for Optional Package Loading</a><a id="Requires.jl-for-Optional-Package-Loading-1"></a><a class="docs-heading-anchor-permalink" href="#Requires.jl-for-Optional-Package-Loading" title="Permalink"></a></h3><p>Many of these packages have additional features that are not included by default.  For example, the <a href="https://fluxml.ai/Flux.jl/stable/">Flux.jl</a> machine learning package will introduce several additional features when loaded, e.g.:</p><pre><code class="language-julia">julia&gt; using Flux, RoME

[ Info: IncrementalInference is adding Flux related functionality.
[ Info: RoME is adding Flux related functionality.</code></pre><p>For completeness, so too with packages like <code>Images.jl</code>, <code>RobotOS.jl</code>, and others:</p><pre><code class="language-julia">using Caesar, Images</code></pre><h2 id="Familiarize-with-Canonical-Factor-Graphs"><a class="docs-heading-anchor" href="#Familiarize-with-Canonical-Factor-Graphs">Familiarize with Canonical Factor Graphs</a><a id="Familiarize-with-Canonical-Factor-Graphs-1"></a><a class="docs-heading-anchor-permalink" href="#Familiarize-with-Canonical-Factor-Graphs" title="Permalink"></a></h2><p>Starting with a shortcut to just quickly getting a small predefined <em>canonical</em> graph containing a few variables and factors can be done with (try tab-completion in the REPL):</p><pre><code class="language-julia">fg = generateCanonicalFG_Kaess()
fg = generateCanonicalFG_LineStep()
fg = generateCanonicalFG_Hexagonal()
fg = generateCanonicalFG_Circle()</code></pre><p>Any one of these <em>generate</em> functions should produce a standard factor graph object that is useful for orientation, testing, learning, or validation.  You can generate any of these factor graphs at any time, for example when quickly wanting to test some idea midway through building a more sophisiticated <code>fg</code>, you might just want to quickly do:</p><pre><code class="language-julia">fg_ = generateCanonicalFG_Hexagonal()</code></pre><p>and then work with <code>fg_</code> to try out something risky.</p><h2 id="Building-a-new-Graph"><a class="docs-heading-anchor" href="#Building-a-new-Graph">Building a new Graph</a><a id="Building-a-new-Graph-1"></a><a class="docs-heading-anchor-permalink" href="#Building-a-new-Graph" title="Permalink"></a></h2><p>The first step is to model the data (using the most appropriate <em>factors</em>) among <em>variables</em> of interest.  To start model, first create a <em>distributed factor graph object</em>:</p><pre><code class="language-julia"># start with an empty factor graph object
fg = initfg()</code></pre><h2 id="Variables"><a class="docs-heading-anchor" href="#Variables">Variables</a><a id="Variables-1"></a><a class="docs-heading-anchor-permalink" href="#Variables" title="Permalink"></a></h2><p>Variables (a.k.a. poses or states in navigation lingo) are created with the <code>addVariable!</code> fucntion call.</p><pre><code class="language-julia"># Add the first pose :x0
addVariable!(fg, :x0, Pose2)
# Add a few more poses
for i in 1:10
  addVariable!(fg, Symbol(&quot;x$(i)&quot;), Pose2)
end</code></pre><p>Variables contain a label, a data type (e.g. in 2D <code>RoME.Point2</code> or <code>RoME.Pose2</code>). Note that variables are solved - i.e. they are the product, what you wish to calculate when the solver runs - so you don&#39;t provide any measurements when creating them.</p><h2 id="Factors"><a class="docs-heading-anchor" href="#Factors">Factors</a><a id="Factors-1"></a><a class="docs-heading-anchor-permalink" href="#Factors" title="Permalink"></a></h2><p>Factors are algebraic relationships between variables based on data cues such as sensor measurements. Examples of factors are absolute (pre-resolved) GPS readings (unary factors/priors) and odometry changes between pose variables. All factors encode a stochastic measurement (measurement + error), such as below, where a <a href="https://www.juliarobotics.org/Caesar.jl/latest/concepts/available_varfacs/#IncrementalInference.Prior"><code>IIF.Prior</code></a> belief is add to <code>x0</code> (using the <a href="https://www.juliarobotics.org/Caesar.jl/latest/func_ref/#DistributedFactorGraphs.addFactor!"><code>addFactor</code></a> call) as a normal distribution centered around <code>[0,0,0]</code>.</p><h3 id="Priors"><a class="docs-heading-anchor" href="#Priors">Priors</a><a id="Priors-1"></a><a class="docs-heading-anchor-permalink" href="#Priors" title="Permalink"></a></h3><pre><code class="language-julia"># Add at a fixed location Prior to pin :x0 to a starting location (0,0,pi/6.0)
addFactor!(fg, [:x0], PriorPose2( MvNormal([0; 0; pi/6.0], Matrix(Diagonal([0.1;0.1;0.05].^2)) )))</code></pre><h3 id="Factors-Between-Variables"><a class="docs-heading-anchor" href="#Factors-Between-Variables">Factors Between Variables</a><a id="Factors-Between-Variables-1"></a><a class="docs-heading-anchor-permalink" href="#Factors-Between-Variables" title="Permalink"></a></h3><pre><code class="language-julia"># Add odometry indicating a zigzag movement
for i in 1:10
  pp = Pose2Pose2(MvNormal([10.0;0; (i % 2 == 0 ? -pi/3 : pi/3)], Matrix(Diagonal([0.1;0.1;0.1].^2))))
  addFactor!(fg, [Symbol(&quot;x$(i-1)&quot;); Symbol(&quot;x$(i)&quot;)], pp )
end</code></pre><h4 id="[OPTIONAL]-Understanding-Internal-Factor-Naming-Convention"><a class="docs-heading-anchor" href="#[OPTIONAL]-Understanding-Internal-Factor-Naming-Convention">[OPTIONAL] Understanding Internal Factor Naming Convention</a><a id="[OPTIONAL]-Understanding-Internal-Factor-Naming-Convention-1"></a><a class="docs-heading-anchor-permalink" href="#[OPTIONAL]-Understanding-Internal-Factor-Naming-Convention" title="Permalink"></a></h4><p>The factor name used by Caesar is automatically generated from </p><pre><code class="language-julia">addFactor!(fg, [:x0; :x1],...)</code></pre><p>will create a factor with name <code>:x0x1f1</code></p><p>When you were to add a another factor betweem <code>:x0</code>, <code>:x1</code>:</p><pre><code class="language-julia">addFactor!(fg, [:x0; :x1],...)</code></pre><p>will create a second factor with the name <code>:x0x1f2</code>.</p><h3 id="Adding-Tags"><a class="docs-heading-anchor" href="#Adding-Tags">Adding Tags</a><a id="Adding-Tags-1"></a><a class="docs-heading-anchor-permalink" href="#Adding-Tags" title="Permalink"></a></h3><p>It is possible to add <code>tags</code> to variables and factors that make later graph management tasks easier, e.g.:</p><pre><code class="language-julia">addVariable!(fg, :l7_3, Pose2, tags=[:APRILTAG; :LANDMARK])</code></pre><h2 id="When-to-Instantiate-Poses-(i.e.-new-Variables-in-Factor-Graph)"><a class="docs-heading-anchor" href="#When-to-Instantiate-Poses-(i.e.-new-Variables-in-Factor-Graph)">When to Instantiate Poses (i.e. new Variables in Factor Graph)</a><a id="When-to-Instantiate-Poses-(i.e.-new-Variables-in-Factor-Graph)-1"></a><a class="docs-heading-anchor-permalink" href="#When-to-Instantiate-Poses-(i.e.-new-Variables-in-Factor-Graph)" title="Permalink"></a></h2><p>Consider a robot traversing some area while exploring, localizing, and wanting to find strong loop-closure features for consistent mapping.  The creation of new poses and landmark variables is a trade-off in computational complexity and marginalization errors made during factor graph construction.  Common triggers for new poses are:</p><ul><li>Time-based trigger (eg. new pose a second or 5 minutes if stationary)</li><li>Distance traveled (eg. new pose every 0.5 meters)</li><li>Rotation angle (eg. new pose every 15 degrees)</li></ul><p>Computation will progress faster if poses and landmarks are very sparse.  To extract the benefit of dense reconstructions, one approach is to use the factor graph as sparse index in history about the general progression of the trajectory and use additional processing from dense sensor data for high-fidelity map reconstructions.  Either interpolations, or better direct reconstructions from inertial data can be used for dense reconstruction.</p><p>For completeness, one could also re-project the most meaningful measurements from sensor measurements between pose epochs as though measured from the pose epoch.  This approach essentially marginalizes the local dead reckoning drift errors into the local interpose re-projections, but helps keep the pose count low.</p><p>In addition, see <a href="https://www.juliarobotics.org/Caesar.jl/latest/examples/examples/#Hexagonal-2D-1">fixed-lag discussion</a> for limiting during inference the number of fluid variables manually to a user desired count.</p><h2 id="Which-Variables-and-Factors-to-use"><a class="docs-heading-anchor" href="#Which-Variables-and-Factors-to-use">Which Variables and Factors to use</a><a id="Which-Variables-and-Factors-to-use-1"></a><a class="docs-heading-anchor-permalink" href="#Which-Variables-and-Factors-to-use" title="Permalink"></a></h2><p>See the next page on <a href="https://www.juliarobotics.org/Caesar.jl/latest/concepts/available_varfacs/">available variables and factors</a></p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../concepts/">« Initial Concepts</a><a class="docs-footer-nextpage" href="../interacting_fgs/">Solving and Interacting »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> on <span class="colophon-date" title="Saturday 31 October 2020 06:18">Saturday 31 October 2020</span>. Using Julia version 1.5.2.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
