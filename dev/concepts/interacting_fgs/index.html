<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Interacting w/ Factor Graphs · Caesar.jl</title><link href="https://fonts.googleapis.com/css?family=Lato|Roboto+Mono" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.11.1/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit">Caesar.jl</span></div><form class="docs-search" action="../../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../../">Introduction</a></li><li><span class="tocitem">Welcome</span><ul><li><a class="tocitem" href="../../installation_environment/">Installation</a></li><li><a class="tocitem" href="../../faq/">FAQ</a></li></ul></li><li><span class="tocitem">Getting Started</span><ul><li><a class="tocitem" href="../concepts/">Initial Concepts</a></li><li><a class="tocitem" href="../building_graphs/">Building Factor Graphs</a></li><li class="is-active"><a class="tocitem" href>Interacting w/ Factor Graphs</a><ul class="internal"><li><a class="tocitem" href="#Building-a-new-Graph"><span>Building a new Graph</span></a></li><li><a class="tocitem" href="#Loading-an-Existing-FileDFG"><span>Loading an Existing FileDFG</span></a></li><li class="toplevel"><a class="tocitem" href="#Querying-the-FactorGraph"><span>Querying the FactorGraph</span></a></li><li class="toplevel"><a class="tocitem" href="#Solving-Graphs"><span>Solving Graphs</span></a></li><li><a class="tocitem" href="#Peeking-at-Results"><span>Peeking at Results</span></a></li><li class="toplevel"><a class="tocitem" href="#Adding-A-FolderStore"><span>Adding A FolderStore</span></a></li><li><a class="tocitem" href="#Adding-Data-Blobs"><span>Adding Data Blobs</span></a></li><li><a class="tocitem" href="#Retrieving-a-Data-Blob"><span>Retrieving a Data Blob</span></a></li></ul></li><li><a class="tocitem" href="../dataassociation/">Data Association</a></li><li><a class="tocitem" href="../available_varfacs/">Available Variables/Factors</a></li><li><a class="tocitem" href="../2d_plotting/">Plotting (2D)</a></li><li><a class="tocitem" href="../multilang/">Multi-Language Support</a></li><li><a class="tocitem" href="../database_interactions/">Cloud Server/Database</a></li><li><a class="tocitem" href="../multisession/">Multi-session/agent Solving</a></li><li><a class="tocitem" href="../arena_visualizations/">Visualization (3D)</a></li></ul></li><li><span class="tocitem">Examples</span><ul><li><a class="tocitem" href="../../examples/examples/">Caesar Examples</a></li><li><a class="tocitem" href="../../examples/basic_continuousscalar/">ContinuousScalar as 1D Example</a></li><li><a class="tocitem" href="../../examples/basic_slamedonut/">Under-defined Trilateration, 2D</a></li><li><a class="tocitem" href="../../examples/basic_hexagonal2d/">Hexagonal 2D SLAM</a></li><li><a class="tocitem" href="../../examples/interm_fixedlag_hexagonal/">Fixed-Lag Solving 2D</a></li><li><a class="tocitem" href="../../examples/deadreckontether/">Dead Reckon Tether</a></li></ul></li><li><span class="tocitem">Principles</span><ul><li><a class="tocitem" href="../../principles/filterCorrespondence/">Filters vs. Graphs</a></li><li><a class="tocitem" href="../../principles/approxConvDensities/">Generic Convolutions</a></li><li><a class="tocitem" href="../../principles/multiplyingDensities/">Multiplying Functions (.py)</a></li><li><a class="tocitem" href="../../principles/bayestreePrinciples/">Bayes (Junction) tree</a></li><li><a class="tocitem" href="../../principles/initializingOnBayesTree/">Advanced Bayes Tree Topics</a></li><li><a class="tocitem" href="../mmisam_alg/">Multimodal iSAM Algorithm</a></li></ul></li><li><span class="tocitem">How to Expand?</span><ul><li><a class="tocitem" href="../adding_variables_factors/">Custom Variables and Factors</a></li><li><a class="tocitem" href="../../examples/basic_definingfactors/">Creating Variables and Factors</a></li><li><a class="tocitem" href="../../examples/interm_dynpose/">Creating DynPose Factor</a></li></ul></li><li><span class="tocitem">Developer Zone</span><ul><li><a class="tocitem" href="../../dev/wiki/">Wiki Pointers</a></li></ul></li><li><span class="tocitem">Literature</span><ul><li><a class="tocitem" href="../../refs/literature/">References</a></li></ul></li><li><span class="tocitem">Function Reference</span><ul><li><a class="tocitem" href="../../func_ref/">Caesar&#39;s Reference</a></li><li><a class="tocitem" href="../../vis_func_ref/">Visualization Reference</a></li></ul></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Getting Started</a></li><li class="is-active"><a href>Interacting w/ Factor Graphs</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Interacting w/ Factor Graphs</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/JuliaRobotics/Caesar.jl/blob/master/docs/src/concepts/interacting_fgs.md" title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="Getting/Building-a-Factor-Graph"><a class="docs-heading-anchor" href="#Getting/Building-a-Factor-Graph">Getting/Building a Factor Graph</a><a id="Getting/Building-a-Factor-Graph-1"></a><a class="docs-heading-anchor-permalink" href="#Getting/Building-a-Factor-Graph" title="Permalink"></a></h1><h2 id="Building-a-new-Graph"><a class="docs-heading-anchor" href="#Building-a-new-Graph">Building a new Graph</a><a id="Building-a-new-Graph-1"></a><a class="docs-heading-anchor-permalink" href="#Building-a-new-Graph" title="Permalink"></a></h2><p>The previous <a href="https://juliarobotics.org/Caesar.jl/latest/concepts/building_graphs/">page shows some of the features in building a new factor graph</a>.</p><p>Another shortcut to just quickly getting a graph is to use one of the existing canonical graphs (try tab-completion in the REPL):</p><pre><code class="language-julia">fg = generateCanonicalFG_Hexagonal()</code></pre><h2 id="Loading-an-Existing-FileDFG"><a class="docs-heading-anchor" href="#Loading-an-Existing-FileDFG">Loading an Existing FileDFG</a><a id="Loading-an-Existing-FileDFG-1"></a><a class="docs-heading-anchor-permalink" href="#Loading-an-Existing-FileDFG" title="Permalink"></a></h2><p>Assuming REPL input:</p><pre><code class="language-julia">pwd() # check current working directory
cd(&quot;/somewhere/local/&quot;) # optional change to working directory
fg = loadDFG(&quot;myFg.tar.gz&quot;) # and load the file, requires IIF v0.15, DFG v0.10</code></pre><h1 id="Querying-the-FactorGraph"><a class="docs-heading-anchor" href="#Querying-the-FactorGraph">Querying the FactorGraph</a><a id="Querying-the-FactorGraph-1"></a><a class="docs-heading-anchor-permalink" href="#Querying-the-FactorGraph" title="Permalink"></a></h1><p>There are a variety of functions to query the factor graph, please refer to <a href="../../func_ref/">Function Reference</a> for details.</p><p>A quick summary of the variables in the factor graph can be retrieved with:</p><pre><code class="language-julia"># List variables
ls(fg)
# List factors attached to x0
ls(fg, :x0)
# TODO: Provide an overview of getVal, getVert, getBW, getBelief, etc.</code></pre><p>Once you have a graph, you can visualize the graph as follows (beware though if the fg object is large):</p><pre><code class="language-julia"># requires `sudo apt-get install graphviz
drawGraph(fg, show=true)</code></pre><p>By setting <code>show=true</code>, the application <code>evince</code> will be called to show the <code>fg.pdf</code> file that was created using <em>GraphViz</em>.  A <code>GraphPlot.jl</code> visualization engine is also available.</p><pre><code class="language-julia">using GraphPlot
dfgplot(fg)</code></pre><p>For more details, see <a href="https://juliarobotics.org/DistributedFactorGraphs.jl/latest/DrawingGraphs/#Drawing-Graphs-1">the DFG docs on Drawing Graphs</a>.</p><h1 id="Solving-Graphs"><a class="docs-heading-anchor" href="#Solving-Graphs">Solving Graphs</a><a id="Solving-Graphs-1"></a><a class="docs-heading-anchor-permalink" href="#Solving-Graphs" title="Permalink"></a></h1><p>When you have built the graph, you can call the solver to perform inference with the following:</p><pre><code class="language-julia"># Perform inference
tree, smt, hist = solveTree!(fg)</code></pre><p>The returned Bayes (Junction) <code>tree</code> object is described in more detail on <a href="https://juliarobotics.org/Caesar.jl/latest/principles/bayestreePrinciples/">a dedicated documentation page</a>, while <code>smt</code> and <code>hist</code> return values most closely relate to development and debug outputs which can be ignored during general use.  Should an error occur during, the exception information is easily accessible in the <code>smt</code> object (as well as file logs which default to <code>/tmp/caesar/</code>).</p><p>One of the major features of the multimodal-iSAM (mmisam) algorithm (implemented by <a href="http://www.github.com/JuliaRobotics/IncrementalInference.jl">IncrementalInference.jl</a>) is reducing computational load by recycling and marginalizing different (usually older) parts of the factor graph.  In order to utilize the benefits of recycing, the previous Bayes (Junction) tree should also be provided as input (see fixed-lag examples for more details):</p><pre><code class="language-julia">tree, smt, hist = solveTree!(fg, tree)</code></pre><h2 id="Peeking-at-Results"><a class="docs-heading-anchor" href="#Peeking-at-Results">Peeking at Results</a><a id="Peeking-at-Results-1"></a><a class="docs-heading-anchor-permalink" href="#Peeking-at-Results" title="Permalink"></a></h2><p>Once you have solved the graph, you can review the full marginal with:</p><pre><code class="language-julia">X0 = getKDE(fg, :x0) # Get the raw KDE
# Evaluate the marginal density function just for fun at [0.01, 0, 0].
X0([0.01, 0, 0])</code></pre><p>For finding the MAP value in the density functions, you can use <code>getKDEMax</code> or <code>getKDEMean</code>. Here we are asking for the MAP values for all the variables in the factor graph:</p><pre><code class="language-julia">varsyms = ls(fg)
map(v -&gt; println(&quot;$v : $(getKDEMax(getKDE(fg, v)))&quot;), varsyms[1]);</code></pre><h1 id="Adding-A-FolderStore"><a class="docs-heading-anchor" href="#Adding-A-FolderStore">Adding A FolderStore</a><a id="Adding-A-FolderStore-1"></a><a class="docs-heading-anchor-permalink" href="#Adding-A-FolderStore" title="Permalink"></a></h1><p>Caesar.jl (with DFG) supports storage and retrieval of larger data blobs by means of various database/datastore technologies.  To get going, you can use a conventional <code>FolderStore</code>: </p><pre><code class="language-none">getSolverParams(fg).logpath = pwd()
storeDir = joinLogPath(fg,&quot;data&quot;)
mkpath(storeDir)
# requires IIF v0.15, DFG v0.10
datastore = FolderStore{Vector{UInt8}}(:default_folder_store, storeDir) 
addBlobStore!(fg, datastore)</code></pre><h2 id="Adding-Data-Blobs"><a class="docs-heading-anchor" href="#Adding-Data-Blobs">Adding Data Blobs</a><a id="Adding-Data-Blobs-1"></a><a class="docs-heading-anchor-permalink" href="#Adding-Data-Blobs" title="Permalink"></a></h2><p>Just showcasing a JSON Dict approach</p><pre><code class="language-none">using JSON2
someDict = Dict(:name =&gt; &quot;Jane&quot;, :data =&gt; randn(100))
addData!(fg, :default_folder_store, :x1, :datalabel, Vector{UInt8}(JSON2.write( someDict )), mimeType=&quot;application/json/octet-stream&quot;  )
# see retrieval example below...</code></pre><p>but much more flexibility is also possible</p><pre><code class="language-julia"># from https://juliaimages.org/stable/install/
using TestImages, Images, ImageView
img = testimage(&quot;mandrill&quot;)
imshow(img)

# TODO, convert to Vector{UInt8}
using ImageMagick, FileIO
# convert image to PNG bytestream
io = IOBuffer()
pngSm = Stream(format&quot;PNG&quot;, io)
save(pngSm, img)  # think FileIO is required for this
pngBytes = take!(io)
addData!(fg, :default_folder_store, :x1, :testImage, pngBytes, mimeType=&quot;image/png&quot;, description=&quot;mandrill test image&quot;  )</code></pre><h2 id="Retrieving-a-Data-Blob"><a class="docs-heading-anchor" href="#Retrieving-a-Data-Blob">Retrieving a Data Blob</a><a id="Retrieving-a-Data-Blob-1"></a><a class="docs-heading-anchor-permalink" href="#Retrieving-a-Data-Blob" title="Permalink"></a></h2><p>Data is stored as an <code>Entry =&gt; Blob</code> relationship, and the entries associated with a variable can be found via</p><pre><code class="language-julia">julia&gt; listDataEntries(fg, :x6)
1-element Array{Symbol,1}:
 :JOYSTICK_CMD_VALS
 :testImage</code></pre><p>And retrieved via:</p><pre><code class="language-julia">rawData = getData(fg, :x6, :JOYSTICK_CMD_VALS);
imgEntry, imgBytes = getData(fg, :x1, :testImage)</code></pre><p>Looking at <code>rawData</code> in a bit more detail:</p><pre><code class="language-julia">julia&gt; rawData[1]
BlobStoreEntry(:JOYSTICK_CMD_VALS, UUID(&quot;d21fc841-6214-4196-a396-b1d5ef95be49&quot;), :default_folder_store, &quot;deeb3ed0cba6ffd149298de21c361af26a207e565e27a3cd3fa6c807b9aaa44d&quot;, &quot;DefaultUser|DefaultRobot|Session_851d81|x6&quot;, &quot;&quot;, &quot;application/json/octet-stream&quot;, TimeZones.ZonedDateTime(2020, 8, 15, 14, 26, 36, 397, tz&quot;UTC-04:00&quot;))

julia&gt; rawData[2]
3362-element Array{UInt8,1}:
 0x5b
 0x5b
 0x32
#...</code></pre><p>For <code>:testImage</code> the data was packed in a familiar <code>image/png</code> and can be converted backto bitmap (array) format:</p><pre><code class="language-julia">rgb = ImageMagick.readblob(imgBytes); # automatically detected as PNG format

using ImageView
imshow(rgb)</code></pre><p>In the other case where data was packed as <code>&quot;application/json/octet-stream&quot;</code>:</p><pre><code class="language-julia">myData = JSON2.read(IOBuffer(rawData[2]))

# as example
julia&gt; myData[1]
3-element Array{Any,1}:
                2017
 1532558043061497600
                    (buttons = Any[0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0], axis = Any[0, 0.25026196241378784, 0, 0, 0, 0])</code></pre><h3 id="Quick-Camera-Calibration-Storage-Example"><a class="docs-heading-anchor" href="#Quick-Camera-Calibration-Storage-Example">Quick Camera Calibration Storage Example</a><a id="Quick-Camera-Calibration-Storage-Example-1"></a><a class="docs-heading-anchor-permalink" href="#Quick-Camera-Calibration-Storage-Example" title="Permalink"></a></h3><p>Consider storing camera calibration data inside the factor graph <code>tar.gz</code> object for later use:</p><pre><code class="language-julia">fx = 341.4563903808594
fy = 341.4563903808594
cx = 329.19091796875
cy = 196.3658447265625

K = [-fx 0  cx;
      0 fy cy]

# Cheap way to include data as a Blob.  Also see the more hacky `Smalldata` alternative for situations that make sense.
camCalib = Dict(:size=&gt;size(K), :vecK=&gt;vec(K))
addData!(dfg,:default_folder_store,:x0,:camCalib,
         Vector{UInt8}(JSON2.write(camCalib)), mimeType=&quot;application/json/octet-stream&quot;, 
         description=&quot;reshape(camCalib[:vecK], camCalib[:size]...)&quot;) </code></pre></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../building_graphs/">« Building Factor Graphs</a><a class="docs-footer-nextpage" href="../dataassociation/">Data Association »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> on <span class="colophon-date" title="Sunday 30 August 2020 19:24">Sunday 30 August 2020</span>. Using Julia version 1.5.1.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
