<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Caching and Stashing · Caesar.jl</title><meta name="title" content="Caching and Stashing · Caesar.jl"/><meta property="og:title" content="Caching and Stashing · Caesar.jl"/><meta property="twitter:title" content="Caching and Stashing · Caesar.jl"/><meta name="description" content="Documentation for Caesar.jl."/><meta property="og:description" content="Documentation for Caesar.jl."/><meta property="twitter:description" content="Documentation for Caesar.jl."/><script data-outdated-warner src="../../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../search_index.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../../">Caesar.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../../">Welcome</a></li><li><span class="tocitem">Introduction</span><ul><li><a class="tocitem" href="../../introduction/">Introduction</a></li><li><a class="tocitem" href="../why_nongaussian/">Gaussian vs. Non-Gaussian</a></li><li><a class="tocitem" href="../../installation_environment/">Installation</a></li><li><a class="tocitem" href="../using_julia/">Using Julia</a></li><li><a class="tocitem" href="../../faq/">FAQ</a></li></ul></li><li><span class="tocitem">Getting Started</span><ul><li><a class="tocitem" href="../concepts/">Initial Concepts</a></li><li><a class="tocitem" href="../building_graphs/">Building Graphs</a></li><li><a class="tocitem" href="../solving_graphs/">Solving Graphs</a></li><li><a class="tocitem" href="../interacting_fgs/">Interact w Graphs</a></li><li><a class="tocitem" href="../dataassociation/">Multi-Modal/Hypothesis</a></li><li><a class="tocitem" href="../parallel_processing/">Parallel Processing</a></li><li><a class="tocitem" href="../../examples/parametric_solve/">[DEV] Parametric Solve</a></li></ul></li><li><span class="tocitem">Examples</span><ul><li><a class="tocitem" href="../../examples/examples/">Caesar Examples</a></li><li><a class="tocitem" href="../../examples/basic_continuousscalar/">Canonical 1D Example</a></li><li><a class="tocitem" href="../../examples/basic_slamedonut/">Underconstrained Range-only</a></li><li><a class="tocitem" href="../../examples/basic_hexagonal2d/">Hexagonal 2D SLAM</a></li><li><a class="tocitem" href="../../examples/interm_fixedlag_hexagonal/">Fixed-Lag Solving 2D</a></li><li><a class="tocitem" href="../../examples/deadreckontether/">Dead Reckon Tether</a></li></ul></li><li><span class="tocitem">Graph Library</span><ul><li><a class="tocitem" href="../../examples/canonical_graphs/">Canonical Generators</a></li><li><a class="tocitem" href="../available_varfacs/">Variables/Factors</a></li><li><a class="tocitem" href="../entry_data/">Entry=&gt;Data Blob</a></li><li><a class="tocitem" href="../../examples/using_images/">Images and AprilTags</a></li><li><a class="tocitem" href="../../examples/using_pcl/">Pointclouds and PCL</a></li><li><a class="tocitem" href="../using_manifolds/">Using Manifolds.jl</a></li><li><a class="tocitem" href="../flux_factors/">Flux (NN) Factors</a></li></ul></li><li><span class="tocitem">Visualization</span><ul><li><a class="tocitem" href="../../install_viz/">Installing Viz</a></li><li><a class="tocitem" href="../2d_plotting/">Plotting (2D)</a></li><li><a class="tocitem" href="../arena_visualizations/">Visualization (3D)</a></li></ul></li><li><span class="tocitem">Middlewares</span><ul><li><a class="tocitem" href="../../examples/using_ros/">ROS Middleware</a></li><li><a class="tocitem" href="../compile_binary/">Compile Binaries</a></li><li><a class="tocitem" href="../zero_install/">Zero Install Solution</a></li><li><a class="tocitem" href="../multisession/">Multi-session/agent Solving</a></li><li><a class="tocitem" href="../multilang/">Multi-Language Support</a></li></ul></li><li><span class="tocitem">How to Expand?</span><ul><li><a class="tocitem" href="../../caesar_framework/">Pkg Framework</a></li><li><a class="tocitem" href="../../examples/custom_variables/">Custom Variables</a></li><li><a class="tocitem" href="../../examples/basic_definingfactors/">Custom Prior Factor</a></li><li><a class="tocitem" href="../../examples/custom_relative_factors/">Custom Relative Factor</a></li><li class="is-active"><a class="tocitem" href>Caching and Stashing</a><ul class="internal"><li><a class="tocitem" href="#Preamble-Cache"><span>Preamble Cache</span></a></li><li><a class="tocitem" href="#section_stash_unstash"><span>Stash Serialization</span></a></li><li><a class="tocitem" href="#stashcache_notes"><span>Notes</span></a></li></ul></li><li><a class="tocitem" href="../../examples/custom_factor_features/">Important Factor Features</a></li><li><a class="tocitem" href="../../examples/adding_variables_factors/">Variable/Factor Considerations</a></li><li><a class="tocitem" href="../../func_ref/">More Functions</a></li></ul></li><li><span class="tocitem">Principles</span><ul><li><a class="tocitem" href="../../principles/filterCorrespondence/">Filters vs. Graphs</a></li><li><a class="tocitem" href="../../principles/approxConvDensities/">Generic Convolutions</a></li><li><a class="tocitem" href="../../principles/multiplyingDensities/">Multiplying Functions (.py)</a></li><li><a class="tocitem" href="../../principles/bayestreePrinciples/">Bayes (Junction) tree</a></li><li><a class="tocitem" href="../../principles/initializingOnBayesTree/">Advanced Bayes Tree Topics</a></li><li><a class="tocitem" href="../mmisam_alg/">Non-Gaussian Algorithm</a></li></ul></li><li><span class="tocitem">Developer Zone</span><ul><li><a class="tocitem" href="../../dev/wiki/">Wiki Pointers</a></li><li><a class="tocitem" href="../../examples/legacy_deffactors/">Legacy Factors</a></li><li><a class="tocitem" href="../../principles/interm_dynpose/">Creating DynPose Factor</a></li><li><a class="tocitem" href="../../dev/known_issues/">Known Issue List</a></li><li><a class="tocitem" href="../../dev/internal_fncs/">Internal Functions</a></li></ul></li><li><span class="tocitem">Literature</span><ul><li><a class="tocitem" href="../../refs/literature/">References</a></li></ul></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">How to Expand?</a></li><li class="is-active"><a href>Caching and Stashing</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Caching and Stashing</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/JuliaRobotics/Caesar.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/JuliaRobotics/Caesar.jl/blob/master/docs/src/concepts/stash_and_cache.md" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="section_stash_and_cache"><a class="docs-heading-anchor" href="#section_stash_and_cache">EXPL Stash and Cache</a><a id="section_stash_and_cache-1"></a><a class="docs-heading-anchor-permalink" href="#section_stash_and_cache" title="Permalink"></a></h1><div class="admonition is-warning"><header class="admonition-header">Warning</header><div class="admonition-body"><p>Stashing and Caching are new EXPERIMENTAL features (22Q2) and is not yet be fully integrated throughout the overall system.  See <a href="#stashcache_notes">Notes</a> below for specific considerations.</p></div></div><p>Caching aims to improve in-place, memory, and communication bandwidth requirements for factor calculations and serialization.</p><h2 id="Preamble-Cache"><a class="docs-heading-anchor" href="#Preamble-Cache">Preamble Cache</a><a id="Preamble-Cache-1"></a><a class="docs-heading-anchor-permalink" href="#Preamble-Cache" title="Permalink"></a></h2><p>The Caesar.jl framework has a standardized feature to preload or cache important data for factor calculations the first time a factor is created/loaded into a graph (i.e. during <a href="../building_graphs/#DistributedFactorGraphs.addFactor!"><code>addFactor!</code></a>).  The <a href="#IncrementalInference.preambleCache"><code>preambleCache</code></a> function runs just once before any computations are performed.  A default dispatch for <code>preambleCache</code> returns <code>nothing</code> as a cache object that is later used in several places throughout the code.</p><h3 id="Overriding-preambleCache"><a class="docs-heading-anchor" href="#Overriding-preambleCache">Overriding <code>preambleCache</code></a><a id="Overriding-preambleCache-1"></a><a class="docs-heading-anchor-permalink" href="#Overriding-preambleCache" title="Permalink"></a></h3><p>A user may choose to override the dispatch for a particular factor&#39;s <code>preambleCache</code> and thereby return a more intricate/optimized cache object for later use.  Any object can be returned, but we strongly recommend you return a type-stable object for best performance in production.  Returning non-concrete types is allowed and likely faster for development, just remember to check type-stability before calling it a day.</p><p>Whatever object is returned by the <code>preambleCache(dfg, vars, fnc)</code> function is referenced and duplicated within the solver code.  During the design, use of cache is expected to predominantly occur during factor sampling, factor residual calculations, and deserialization (i.e. unpacking) of previously persisted graph objects.</p><p>The <code>preambleCache</code> function has access to the parent factor graph object as well as an ordered list of the <code>DFGVariable</code>s attached to said factor.  The user created factor type objects passed as the third argument.  The combination of these three objects allows the user much freedom wrt to where and how large data might be stored in the system.</p><article class="docstring"><header><a class="docstring-article-toggle-button fa-solid fa-chevron-down" href="javascript:;" title="Collapse docstring"></a><a class="docstring-binding" id="IncrementalInference.preambleCache" href="#IncrementalInference.preambleCache"><code>IncrementalInference.preambleCache</code></a> — <span class="docstring-category">Function</span><span class="is-flex-grow-1 docstring-article-toggle-button" title="Collapse docstring"></span></header><section><div><pre><code class="language-julia hljs">preambleCache(dfg, vars, usrfnc)
</code></pre><p>Overload for specific factor preamble usage.</p><p>Notes:</p><ul><li>See https://github.com/JuliaRobotics/IncrementalInference.jl/issues/1462</li></ul><p>DevNotes</p><ul><li>Integrate into CalcFactor<ul><li>Add threading</li></ul></li></ul><p>Example:</p><pre><code class="language-julia hljs">import IncrementalInference: preableCache

preableCache(dfg::AbstractDFG, vars::AbstractVector{&lt;:DFGVariable}, usrfnc::MyFactor) = MyFactorCache(randn(10))

# continue regular use, e.g.
mfc = MyFactor(...)
addFactor!(fg, [:a;:b], mfc)
# ... </code></pre></div><a class="docs-sourcelink" target="_blank" href="https://github.com/JuliaRobotics/IncrementalInference.jl/blob/v0.35.4/src/services/FactorGraph.jl#L681-L705">source</a></section></article><h3 id="In-Place-vs.-In-Line-Cache"><a class="docs-heading-anchor" href="#In-Place-vs.-In-Line-Cache">In-Place vs. In-Line Cache</a><a id="In-Place-vs.-In-Line-Cache-1"></a><a class="docs-heading-anchor-permalink" href="#In-Place-vs.-In-Line-Cache" title="Permalink"></a></h3><p>Depending on your particular bent, two different cache models might be more appealing.  The design of <code>preambleCache</code> does not preclude either design options, and actually promote use of either depending on the particular situation at hand.  The purpose of <code>preambleCache</code> is to provide and opportunity for caching when working with factors in the factor graph rather than dictate one design over the other.</p><h4 id="CalcFactor.cache::T"><a class="docs-heading-anchor" href="#CalcFactor.cache::T"><code>CalcFactor.cache::T</code></a><a id="CalcFactor.cache::T-1"></a><a class="docs-heading-anchor-permalink" href="#CalcFactor.cache::T" title="Permalink"></a></h4><p>One likely use of the <code>preambleCache</code> function is for in-place memory allocation for solver hot-loop operations.  Consider for example a <a href="@ref"><code>getSample</code></a> or factor residual calculation that is memory intensive.  The best way to improve performance is remove any memory allocations during the hot-loop.  For this reason the <code>CalcFactor</code> object has a <code>cache::T</code> field which will have exactly the type <code>::T</code> that is returned by the user&#39;s <code>preambleCache</code> dispatch override.  To usein the factor <code>getSample</code> or residual functions, simply use the <code>calcfactor.cache</code> field.</p><h4 id="Pulling-Data-from-Stores"><a class="docs-heading-anchor" href="#Pulling-Data-from-Stores">Pulling Data from Stores</a><a id="Pulling-Data-from-Stores-1"></a><a class="docs-heading-anchor-permalink" href="#Pulling-Data-from-Stores" title="Permalink"></a></h4><p>The Caesar.jl framework <a href="../entry_data/#section_data_entry_blob_store">supports various data store</a> designs.  Some of these data stores are likely best suited for in-line caching design.  Values can be <a href="../entry_data/#section_retrieve_data_blob">retrieved from a data store</a> during the <code>preambleCache</code> step, irrespective of where the data is stored.  </p><p>If the user chooses to store weird and wonderful caching links to alternative hardware via the described caching, go forth and be productive!  Consider sharing enhancements back the public repositories.</p><h2 id="section_stash_unstash"><a class="docs-heading-anchor" href="#section_stash_unstash">Stash Serialization</a><a id="section_stash_unstash-1"></a><a class="docs-heading-anchor-permalink" href="#section_stash_unstash" title="Permalink"></a></h2><div class="admonition is-info"><header class="admonition-header">Note</header><div class="admonition-body"><p>Stashing uses <a href="../entry_data/#section_data_entry_blob_store">Additional (Large) Data</a> storage and retrieval following starved graph design considerations.</p></div></div><p>Some applications use graph factors with with large memory requirements during computation.  Often, it is not efficient/performant to store large data blobs directly within the graph when persisted.  Caesar.jl therefore supports a concept called <em>stashing</em> (similar to starved graphs), where particular operationally important data is stored separately from the graph which can then be retrieved during the <code>preambleCache</code> step – a.k.a. <em>unstashing</em>.</p><h3 id="Deserialize-only-Stash-Design-(i.e.-unstashing)"><a class="docs-heading-anchor" href="#Deserialize-only-Stash-Design-(i.e.-unstashing)">Deserialize-only Stash Design (i.e. unstashing)</a><a id="Deserialize-only-Stash-Design-(i.e.-unstashing)-1"></a><a class="docs-heading-anchor-permalink" href="#Deserialize-only-Stash-Design-(i.e.-unstashing)" title="Permalink"></a></h3><p>Presently, we recommend following a deserialize-only design.  This is where factor graph are reconstituted from some persisted storage into computable form in memory, a.k.a. <a href="../interacting_fgs/#DistributedFactorGraphs.loadDFG"><code>loadDFG</code></a>.  During the load steps, factors are added to the destination graph using the <code>addFactor!</code> calls, which in turn call <code>preambleCache</code> for each factor.  </p><p>Therefore,  factors which are persisted using the &#39;stash&#39; methodology are only fully reconstructed after the <code>preambleCache</code> step, and the user is responsible for defining the <code>preambleCache</code> override for a particular factor.  The desired stashed data should also already be available in said data store before the factor graph is loaded.</p><p>Caesar.jl does have factors that can use the stash design, but are currently only available as experimental features.  Specifically, see the <a href="../../examples/using_pcl/#Caesar.ScatterAlignPose2"><code>ScatterAlignPose2</code></a> factor code.</p><p>Modifying the overall Caesar.jl code for both read and write stashing might be considered in future work but is not in the current roadmap.</p><h2 id="stashcache_notes"><a class="docs-heading-anchor" href="#stashcache_notes">Notes</a><a id="stashcache_notes-1"></a><a class="docs-heading-anchor-permalink" href="#stashcache_notes" title="Permalink"></a></h2><p>Please see or open issues for specific questions not yet covered here.  You can also reach out via Slack, or contact <a href="https://www.wherewhen.ai">NavAbility</a> for help.</p><ul><li>Use caution in designing <a href="#IncrementalInference.preambleCache"><code>preambleCache</code></a> for situations where <a href="../dataassociation/#section_multihypo"><code>multihypo=</code></a> functionality is used.  If factor memory is tied to specific variables, then the association ambiguities to multihypo situations at compute time must considered.  E.g. if you are storing images for two landmarks in two landmark variable hypotheses, then just remember that the user cache must during the sampling or residual calculations track which hypothesis is being used before using said data – we recommend using <code>NamedTuple</code> in your cache structure.</li><li>If using the Deserialize-Stash design, note that the appropriate data blob stores should already be attached to the destination factor graph object, else the <code>preambleCache</code> function will not be able to succesfully access any of the <code>getData</code> functions you are likely to use to &#39;unstash&#39; data.</li><li>Users can readily implement their own threading inside factor samping and residual computations.  Caching is not yet thread-safe for some internal solver side-by-side computations, User can self manage shared vs. separate memory for the <code>Multithreaded Factor</code> option, but we&#39;d recommend reaching out to or getting involved with the threading redesign, see <a href="https://github.com/JuliaRobotics/IncrementalInference.jl/issues/1094">IIF 1094</a>.</li></ul></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../../examples/custom_relative_factors/">« Custom Relative Factor</a><a class="docs-footer-nextpage" href="../../examples/custom_factor_features/">Important Factor Features »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.6.0 on <span class="colophon-date" title="Monday 26 August 2024 23:45">Monday 26 August 2024</span>. Using Julia version 1.10.4.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
