<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Parallel Processing · Caesar.jl</title><script data-outdated-warner src="../../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.039/juliamono-regular.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.11/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../../">Caesar.jl</a></span></div><form class="docs-search" action="../../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../../">Welcome</a></li><li><span class="tocitem">Introduction</span><ul><li><a class="tocitem" href="../../introduction/">Introduction</a></li><li><a class="tocitem" href="../why_nongaussian/">Gaussian vs. Non-Gaussian</a></li><li><a class="tocitem" href="../../installation_environment/">Installation</a></li><li><a class="tocitem" href="../using_julia/">Using Julia</a></li><li><a class="tocitem" href="../../faq/">FAQ</a></li></ul></li><li><span class="tocitem">Getting Started</span><ul><li><a class="tocitem" href="../concepts/">Initial Concepts</a></li><li><a class="tocitem" href="../building_graphs/">Building Graphs</a></li><li><a class="tocitem" href="../solving_graphs/">Solving Graphs</a></li><li><a class="tocitem" href="../interacting_fgs/">Interact w Graphs</a></li><li><a class="tocitem" href="../dataassociation/">Multi-Modal/Hypothesis</a></li><li class="is-active"><a class="tocitem" href>Parallel Processing</a><ul class="internal"><li><a class="tocitem" href="#Multiprocessing"><span>Multiprocessing</span></a></li><li><a class="tocitem" href="#Start-up-Time"><span>Start-up Time</span></a></li><li><a class="tocitem" href="#Multithreading"><span>Multithreading</span></a></li></ul></li><li><a class="tocitem" href="../using_manifolds/">Using Manifolds.jl</a></li><li><a class="tocitem" href="../../examples/parametric_solve/">[DEV] Parametric Solve</a></li></ul></li><li><span class="tocitem">Examples</span><ul><li><a class="tocitem" href="../../examples/examples/">Caesar Examples</a></li><li><a class="tocitem" href="../../examples/basic_continuousscalar/">Canonical 1D Example</a></li><li><a class="tocitem" href="../../examples/basic_slamedonut/">Underconstrained Range-only</a></li><li><a class="tocitem" href="../../examples/basic_hexagonal2d/">Hexagonal 2D SLAM</a></li><li><a class="tocitem" href="../../examples/interm_fixedlag_hexagonal/">Fixed-Lag Solving 2D</a></li><li><a class="tocitem" href="../../examples/deadreckontether/">Dead Reckon Tether</a></li></ul></li><li><span class="tocitem">Graph Library</span><ul><li><a class="tocitem" href="../../examples/canonical_graphs/">Canonical Generators</a></li><li><a class="tocitem" href="../entry_data/">Entry=&gt;Data Blob</a></li><li><a class="tocitem" href="../available_varfacs/">Variables/Factors</a></li><li><a class="tocitem" href="../flux_factors/">Flux (NN) Factors</a></li><li><a class="tocitem" href="../../examples/using_images/">Images and AprilTags</a></li></ul></li><li><span class="tocitem">Visualization</span><ul><li><a class="tocitem" href="../../install_viz/">Installing Viz</a></li><li><a class="tocitem" href="../2d_plotting/">Plotting (2D)</a></li><li><a class="tocitem" href="../arena_visualizations/">Visualization (3D)</a></li></ul></li><li><span class="tocitem">Middlewares</span><ul><li><a class="tocitem" href="../../examples/using_ros/">ROS Middleware</a></li><li><a class="tocitem" href="../compile_binary/">Compile Binaries</a></li><li><a class="tocitem" href="../zero_install/">Zero Install Solution</a></li><li><a class="tocitem" href="../multisession/">Multi-session/agent Solving</a></li><li><a class="tocitem" href="../multilang/">Multi-Language Support</a></li></ul></li><li><span class="tocitem">How to Expand?</span><ul><li><a class="tocitem" href="../../caesar_framework/">Pkg Framework</a></li><li><a class="tocitem" href="../../examples/custom_variables/">Custom Variables</a></li><li><a class="tocitem" href="../../examples/basic_definingfactors/">Custom Prior Factor</a></li><li><a class="tocitem" href="../../examples/custom_relative_factors/">Custom Relative Factor</a></li><li><a class="tocitem" href="../../examples/custom_factor_features/">Important Factor Features</a></li><li><a class="tocitem" href="../../examples/adding_variables_factors/">Variable/Factor Considerations</a></li><li><a class="tocitem" href="../../func_ref/">More Functions</a></li></ul></li><li><span class="tocitem">Principles</span><ul><li><a class="tocitem" href="../../principles/filterCorrespondence/">Filters vs. Graphs</a></li><li><a class="tocitem" href="../../principles/approxConvDensities/">Generic Convolutions</a></li><li><a class="tocitem" href="../../principles/multiplyingDensities/">Multiplying Functions (.py)</a></li><li><a class="tocitem" href="../../principles/bayestreePrinciples/">Bayes (Junction) tree</a></li><li><a class="tocitem" href="../../principles/initializingOnBayesTree/">Advanced Bayes Tree Topics</a></li><li><a class="tocitem" href="../mmisam_alg/">Non-Gaussian Algorithm</a></li></ul></li><li><span class="tocitem">Developer Zone</span><ul><li><a class="tocitem" href="../../dev/wiki/">Wiki Pointers</a></li><li><a class="tocitem" href="../../examples/legacy_deffactors/">Legacy Factors</a></li><li><a class="tocitem" href="../../principles/interm_dynpose/">Creating DynPose Factor</a></li><li><a class="tocitem" href="../../dev/known_issues/">Known Issue List</a></li><li><a class="tocitem" href="../../dev/internal_fncs/">Internal Functions</a></li></ul></li><li><span class="tocitem">Literature</span><ul><li><a class="tocitem" href="../../refs/literature/">References</a></li></ul></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Getting Started</a></li><li class="is-active"><a href>Parallel Processing</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Parallel Processing</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/JuliaRobotics/Caesar.jl/blob/master/docs/src/concepts/parallel_processing.md" title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="Parallel-Processing"><a class="docs-heading-anchor" href="#Parallel-Processing">Parallel Processing</a><a id="Parallel-Processing-1"></a><a class="docs-heading-anchor-permalink" href="#Parallel-Processing" title="Permalink"></a></h1><div class="admonition is-info"><header class="admonition-header">Note</header><div class="admonition-body"><p>Keywords: parallel processing, multi-threading, multi-process</p></div></div><p>Julia allows <a href="https://docs.julialang.org/en/v1/manual/parallel-computing/">high-performance, parallel processing from the ground up</a>.  Depending on the configuration, Caesar.jl can utilize a combination of four styles of multiprocessing: i) separate memory multi-process; ii) shared memory multi-threading; iii) asynchronous shared-memory (forced-atomic) co-routines; and iv) multi-architecture such as JuliaGPU.  As of Julia 1.4, the most reliable method of loading all code into all contexts (for multi-processor speedup) is as follows.</p><h2 id="Multiprocessing"><a class="docs-heading-anchor" href="#Multiprocessing">Multiprocessing</a><a id="Multiprocessing-1"></a><a class="docs-heading-anchor-permalink" href="#Multiprocessing" title="Permalink"></a></h2><p>Make sure the environment variable <code>JULIA_NUM_THREADS</code> is set as default or per call and recommended to use 4 as starting point.</p><pre><code class="nohighlight hljs">JULIA_NUM_THREADS=4 julia -O3</code></pre><p>In addition to multithreading, Caesar.jl utilizes multiprocessing to distribute computation during the inference steps.  Following standard Julia, more processes can be added as follows:</p><pre><code class="language-julia hljs"># load the required packages into procid()==1
using Flux, RoME, Caesar, RoMEPlotting

# then start more processes
using Distributed
addprocs(8) # note this yields 6*8=40 possible processing threads

# now make sure all code is loaded everywhere (for separate memory cases)
@everywhere using Flux, RoME, Caesar</code></pre><p>It might also be convenient to warm up some of the Just-In-Time compiling:</p><pre><code class="language-julia hljs"># solve a few graphs etc, to get majority of solve code compiled before running a robot.
[warmUpSolverJIT() for i in 1:3];</code></pre><h2 id="Start-up-Time"><a class="docs-heading-anchor" href="#Start-up-Time">Start-up Time</a><a id="Start-up-Time-1"></a><a class="docs-heading-anchor-permalink" href="#Start-up-Time" title="Permalink"></a></h2><p>The best way to avoid compile time (when not developing) is to use the established Julia &quot;first time to plot&quot; approach based on PackageCompiler.jl, and more details are provided at <a href="../compile_binary/#compile_binaries">Ahead of Time compiling</a>.</p><h2 id="Multithreading"><a class="docs-heading-anchor" href="#Multithreading">Multithreading</a><a id="Multithreading-1"></a><a class="docs-heading-anchor-permalink" href="#Multithreading" title="Permalink"></a></h2><p>Julia has strong support for shared-memory multithreading.  The most sensible breakdown into threaded work is either within each factor calculation or across individual samples of a factor calculation.  Either of these cases require some special considerations.</p><h3 id="Threading-Within-the-Residual"><a class="docs-heading-anchor" href="#Threading-Within-the-Residual">Threading Within the Residual</a><a id="Threading-Within-the-Residual-1"></a><a class="docs-heading-anchor-permalink" href="#Threading-Within-the-Residual" title="Permalink"></a></h3><p>A factor residual function itself can be broken down further into threaded operations.  For example, see many of the features available at <a href="https://github.com/JuliaSIMD/LoopVectorization.jl">JuliaSIMD/LoopVectorization.jl</a>.  It is recommended to keep memory allocations down to zero, since the solver code will call on the factor samping and residual funtions mulitple times in random access.  Also keep in mind the interaction between conventional thread pool balancing and the newer <a href="https://julialang.org/blog/2019/07/multithreading/">PARTR cache senstive automated thread scheduling</a>.</p><h3 id="Threading-Across-Parallel-Samples"><a class="docs-heading-anchor" href="#Threading-Across-Parallel-Samples">Threading Across Parallel Samples</a><a id="Threading-Across-Parallel-Samples-1"></a><a class="docs-heading-anchor-permalink" href="#Threading-Across-Parallel-Samples" title="Permalink"></a></h3><p>IncrementalInference.jl internally has the capability to span threads across samples in parallel computations during convolution operations.  Keep in mind which parts of residual factor computation is shared memory.  Likely the best course of action is for the factor definition to pre-allocate <code>Threads.nthreads()</code> many memory blocks for factor in-place operations.</p><p>To use this feature, IIF must be told that there are no data race concerns with a factor.  The current API uses a keyword argument on <a href="../building_graphs/#DistributedFactorGraphs.addFactor!"><code>addFactor!</code></a>:</p><pre><code class="language-julia hljs">addFactor!(fg, [:x0; :x1], MyFactor(...); threadmodel=MultiThreaded)</code></pre><div class="admonition is-warning"><header class="admonition-header">Warning</header><div class="admonition-body"><p>The current IIF factor multithreading interface is likely to be reworked/improved in the near future (penciled in for 1H2022).</p></div></div><p>See page <a href="../../examples/custom_relative_factors/#custom_relative_factor">Custom Factors</a> for details on how factor computations are represented in code.  Regarding threading, consider for example <code>OtherFactor.userdata</code>.  The residual calculations from different threads might create a data race on <code>userdata</code> for some volatile internal computation.  In that case it is recommended the to instead use <code>Threads.nthreads()</code> and <code>Threads.threadid()</code> to make sure the shared-memory issues are avoided:</p><pre><code class="language-julia hljs">struct MyThreadSafeFactor{T &lt;: SamplableBelief} &lt;: IIF.AbstractManifoldMinimize
  Z::T
  inplace::Vector{MyInplaceMem}
end

# helper function
MyThreadSafeFactor(z) = MyThreadSafeFactor(z, [MyInplaceMem(0) for i in 1:Threads.nthreads()])

# in residual function just use `thr_inplace = cfo.factor.inplace[Threads.threadid()]`</code></pre><div class="admonition is-info"><header class="admonition-header">Note</header><div class="admonition-body"><p>Beyond the cases discussed above, other features in the IncrementalInference.jl code base (especially regarding the Bayes tree) are already multithreaded.</p></div></div></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../dataassociation/">« Multi-Modal/Hypothesis</a><a class="docs-footer-nextpage" href="../using_manifolds/">Using Manifolds.jl »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 0.27.15 on <span class="colophon-date" title="Wednesday 6 April 2022 05:13">Wednesday 6 April 2022</span>. Using Julia version 1.7.2.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
