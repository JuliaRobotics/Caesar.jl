<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Custom Relative Factor · Caesar.jl</title><script data-outdated-warner src="../../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.039/juliamono-regular.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.11/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../../">Caesar.jl</a></span></div><form class="docs-search" action="../../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../../">Welcome</a></li><li><span class="tocitem">Introduction</span><ul><li><a class="tocitem" href="../../introduction/">Introduction</a></li><li><a class="tocitem" href="../../concepts/why_nongaussian/">Gaussian vs. Non-Gaussian</a></li><li><a class="tocitem" href="../../installation_environment/">Installation</a></li><li><a class="tocitem" href="../../concepts/using_julia/">Using Julia</a></li><li><a class="tocitem" href="../../faq/">FAQ</a></li></ul></li><li><span class="tocitem">Getting Started</span><ul><li><a class="tocitem" href="../../concepts/concepts/">Initial Concepts</a></li><li><a class="tocitem" href="../../concepts/building_graphs/">Building Graphs</a></li><li><a class="tocitem" href="../../concepts/solving_graphs/">Solving Graphs</a></li><li><a class="tocitem" href="../../concepts/interacting_fgs/">Interact w Graphs</a></li><li><a class="tocitem" href="../../concepts/dataassociation/">Multi-Modal/Hypothesis</a></li><li><a class="tocitem" href="../../concepts/parallel_processing/">Parallel Processing</a></li><li><a class="tocitem" href="../../concepts/using_manifolds/">Using Manifolds.jl</a></li><li><a class="tocitem" href="../parametric_solve/">[DEV] Parametric Solve</a></li></ul></li><li><span class="tocitem">Examples</span><ul><li><a class="tocitem" href="../examples/">Caesar Examples</a></li><li><a class="tocitem" href="../basic_continuousscalar/">Canonical 1D Example</a></li><li><a class="tocitem" href="../basic_slamedonut/">Underconstrained Range-only</a></li><li><a class="tocitem" href="../basic_hexagonal2d/">Hexagonal 2D SLAM</a></li><li><a class="tocitem" href="../interm_fixedlag_hexagonal/">Fixed-Lag Solving 2D</a></li><li><a class="tocitem" href="../deadreckontether/">Dead Reckon Tether</a></li></ul></li><li><span class="tocitem">Graph Library</span><ul><li><a class="tocitem" href="../canonical_graphs/">Canonical Generators</a></li><li><a class="tocitem" href="../../concepts/entry_data/">Entry=&gt;Data Blob</a></li><li><a class="tocitem" href="../../concepts/available_varfacs/">Variables/Factors</a></li><li><a class="tocitem" href="../../concepts/flux_factors/">Flux (NN) Factors</a></li><li><a class="tocitem" href="../using_images/">Images and AprilTags</a></li></ul></li><li><span class="tocitem">Visualization</span><ul><li><a class="tocitem" href="../../install_viz/">Installing Viz</a></li><li><a class="tocitem" href="../../concepts/2d_plotting/">Plotting (2D)</a></li><li><a class="tocitem" href="../../concepts/arena_visualizations/">Visualization (3D)</a></li></ul></li><li><span class="tocitem">Middlewares</span><ul><li><a class="tocitem" href="../using_ros/">ROS Middleware</a></li><li><a class="tocitem" href="../../concepts/compile_binary/">Compile Binaries</a></li><li><a class="tocitem" href="../../concepts/zero_install/">Zero Install Solution</a></li><li><a class="tocitem" href="../../concepts/multisession/">Multi-session/agent Solving</a></li><li><a class="tocitem" href="../../concepts/multilang/">Multi-Language Support</a></li></ul></li><li><span class="tocitem">How to Expand?</span><ul><li><a class="tocitem" href="../../caesar_framework/">Pkg Framework</a></li><li><a class="tocitem" href="../custom_variables/">Custom Variables</a></li><li><a class="tocitem" href="../basic_definingfactors/">Custom Prior Factor</a></li><li class="is-active"><a class="tocitem" href>Custom Relative Factor</a><ul class="internal"><li><a class="tocitem" href="#Define-the-relative-struct"><span>Define the relative struct</span></a></li><li><a class="tocitem" href="#Specialized-Dispatch-(getManifold,-getSample)"><span>Specialized Dispatch (<code>getManifold</code>, <code>getSample</code>)</span></a></li><li><a class="tocitem" href="#factor_residual_function"><span>Factor Residual Function</span></a></li></ul></li><li><a class="tocitem" href="../custom_factor_features/">Important Factor Features</a></li><li><a class="tocitem" href="../adding_variables_factors/">Variable/Factor Considerations</a></li><li><a class="tocitem" href="../../func_ref/">More Functions</a></li></ul></li><li><span class="tocitem">Principles</span><ul><li><a class="tocitem" href="../../principles/filterCorrespondence/">Filters vs. Graphs</a></li><li><a class="tocitem" href="../../principles/approxConvDensities/">Generic Convolutions</a></li><li><a class="tocitem" href="../../principles/multiplyingDensities/">Multiplying Functions (.py)</a></li><li><a class="tocitem" href="../../principles/bayestreePrinciples/">Bayes (Junction) tree</a></li><li><a class="tocitem" href="../../principles/initializingOnBayesTree/">Advanced Bayes Tree Topics</a></li><li><a class="tocitem" href="../../concepts/mmisam_alg/">Non-Gaussian Algorithm</a></li></ul></li><li><span class="tocitem">Developer Zone</span><ul><li><a class="tocitem" href="../../dev/wiki/">Wiki Pointers</a></li><li><a class="tocitem" href="../legacy_deffactors/">Legacy Factors</a></li><li><a class="tocitem" href="../../principles/interm_dynpose/">Creating DynPose Factor</a></li><li><a class="tocitem" href="../../dev/known_issues/">Known Issue List</a></li><li><a class="tocitem" href="../../dev/internal_fncs/">Internal Functions</a></li></ul></li><li><span class="tocitem">Literature</span><ul><li><a class="tocitem" href="../../refs/literature/">References</a></li></ul></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">How to Expand?</a></li><li class="is-active"><a href>Custom Relative Factor</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Custom Relative Factor</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/JuliaRobotics/Caesar.jl/blob/master/docs/src/examples/custom_relative_factors.md" title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="custom_relative_factor"><a class="docs-heading-anchor" href="#custom_relative_factor">Custom Relative Factor</a><a id="custom_relative_factor-1"></a><a class="docs-heading-anchor-permalink" href="#custom_relative_factor" title="Permalink"></a></h1><table><tr><th style="text-align: left">Required</th><th style="text-align: left">Brief description</th></tr><tr><td style="text-align: left"><code>MyFactor</code>  struct</td><td style="text-align: left">Prior (<code>&lt;:AbstractPrior</code>) or Relative (<code>&lt;:AbstractManifoldMinimize</code>) factor definition</td></tr><tr><td style="text-align: left"><code>getManifold</code></td><td style="text-align: left">The manifold of the factor</td></tr><tr><td style="text-align: left"><code>(cfo::CalcFactor{&lt;:MyFactor})</code></td><td style="text-align: left">Factor residual function</td></tr><tr><td style="text-align: left"><strong>Optional methods</strong></td><td style="text-align: left"><strong>Brief description</strong></td></tr><tr><td style="text-align: left"><code>getSample(cfo::CalcFactor{&lt;:MyFactor})</code></td><td style="text-align: left">Get a sample from the measurement model</td></tr></table><h2 id="Define-the-relative-struct"><a class="docs-heading-anchor" href="#Define-the-relative-struct">Define the relative struct</a><a id="Define-the-relative-struct-1"></a><a class="docs-heading-anchor-permalink" href="#Define-the-relative-struct" title="Permalink"></a></h2><p>Previously we looked at making a <a href="../basic_definingfactors/#custom_prior_factor">Custom Prior Factor</a>.  This section describes how to build <em>relative factors</em>.  Relative factors introduce relative-only information between variables in the factor graph, and do not add any absolute information.  For example, a rigid transform between two variables is a relative relationship, regardless of their common absolute position in the world.</p><p>Lets look at either the <a href="examples/@ref"><code>EuclidDistance</code></a> of <a href="../../concepts/available_varfacs/#RoME.Pose2Pose2"><code>Pose2Pose2</code></a> factors as simple examples.  First, create the uniquely named factor struct:</p><pre><code class="language-julia hljs">struct EuclidDistance{T &lt;: IIF.SamplableBelief} &lt;: IIF.AbstractManifoldMinimize
  Z::T
end</code></pre><p>New relative factors should either inheret from <code>&lt;:AbstractManifoldMinimize</code>, <code>&lt;:AbstractRelativeMinimize</code>, or <code>&lt;:AbstractRelativeRoots</code>.  These are all subtypes of <code>&lt;:AbstractRelative</code>.  There are only two abstract super types, <code>&lt;:AbstractPrior</code> and <code>&lt;:AbstractRelative</code>.</p><h2 id="Specialized-Dispatch-(getManifold,-getSample)"><a class="docs-heading-anchor" href="#Specialized-Dispatch-(getManifold,-getSample)">Specialized Dispatch (<code>getManifold</code>, <code>getSample</code>)</a><a id="Specialized-Dispatch-(getManifold,-getSample)-1"></a><a class="docs-heading-anchor-permalink" href="#Specialized-Dispatch-(getManifold,-getSample)" title="Permalink"></a></h2><p>Relative factors involve computaton, these computations must be performed on some manifold.  Custom relative factors require that the <a href="examples/@ref"><code>getManifold</code></a> function be overridded.  Here two examples are given for reference:</p><pre><code class="language-julia hljs"># import override/specialize the multiple dispatch
import DistributedFactorGraphs: getManifold

# two examples of existing functions in the standard libraries
DFG.getManifold(::EuclidDistance) = Manifolds.TranslationGroup(1)
DFG.getManifold(::Pose2Pose2) = Manifolds.SpecialEuclidean(2)</code></pre><p>Extending the <code>getSample</code> method for our <code>EuclidDistance</code> factor example is not required, since the default dispatch using field <code>.Z &lt;: SamplableBelief</code> will already be able to sample the measurement – see <a href="../basic_definingfactors/#specialized_getSample">Specialized <code>getSample</code></a>.</p><p>One <strong>important note</strong> is that <code>getSample</code> for <code>&lt;:AbstractRelative</code> factors should return measurement values as manifold tangent vectors – for computational efficiency reasons.</p><p>If more advanced sampling is required, extend the <code>getSample</code> function. </p><pre><code class="language-julia hljs">function getSample(cf::CalcFactor{&lt;:Pose2Pose2}) 
  M = getManifold(cf.factor)
  ϵ = getPointIdentity(Pose2)
  X = sampleTangent(M, cf.factor.Z, ϵ)
  return X
end</code></pre><p>The return type for <code>getSample</code> is unrestricted, and will be passed to the residual function &quot;as-is&quot;.</p><div class="admonition is-info"><header class="admonition-header">Note</header><div class="admonition-body"><p>Default dispatches in <code>IncrementalInference</code> will try use <code>cf.factor.Z</code> to <code>samplePoint</code> on manifold (for <code>&lt;:AbstractPrior</code>) or <code>sampleTangent</code> (for <code>&lt;:AbstractRelative</code>), which simplifies new factor definitions.  If, however, you wish to build more complicated sampling processes, then simply define your own <code>getSample(cf::CalcFactor{&lt;:MyFactor})</code> function.</p></div></div><h2 id="factor_residual_function"><a class="docs-heading-anchor" href="#factor_residual_function">Factor Residual Function</a><a id="factor_residual_function-1"></a><a class="docs-heading-anchor-permalink" href="#factor_residual_function" title="Permalink"></a></h2><p>The selection of <code>&lt;:IIF.AbstractManifoldMinimize</code>, akin to earlier <code>&lt;:AbstractPrior</code>, instructs IIF to find the minimum of the provided residual function.  The residual function is used during inference to approximate the convolution of conditional beliefs from the approximate beliefs of the connected variables in the factor graph.  Conceptually, the residual function is usually something akin to <code>residual = measurement - prediction</code>, but does not have to follow the exact recipe.</p><p>The returned value (the factor measurement) from <code>getSample</code> will always be passed as the first argument (e.g. <code>X</code>) to the factor residual function.  </p><pre><code class="language-julia hljs"># first residual function example
(cf::CalcFactor{&lt;:EuclidDistance})(X, p, q) = X - norm(p .- q)

# second residual function example
function (cf::CalcFactor{&lt;:Pose2Pose2})(X, p, q)
    M = getManifold(Pose2)
    q̂ = Manifolds.compose(M, p, exp(M, identity_element(M, p), X))
    Xc = vee(M, q, log(M, q, q̂))
    return Xc
end</code></pre><div class="admonition is-info"><header class="admonition-header">Note</header><div class="admonition-body"><p>At present (2021) the residual function should return the residual value as a coordinate (not as tangent vectors or manifold points).  Ongoing work is in progress, and likely to return residual values as manifold tangent vectors instead.</p></div></div><p>It is recommended to leave the incoming types unrestricted.  If you must define the types, make sure to allow sufficient dispatch freedom (i.e. dispatch to concrete types) and not force operations to &quot;non-concrete&quot; types.  Usage can be very case specific, and hence better to let Julia type-inference automation do the hard work of inferring the concrete types.</p><h3 id="Serialization"><a class="docs-heading-anchor" href="#Serialization">Serialization</a><a id="Serialization-1"></a><a class="docs-heading-anchor-permalink" href="#Serialization" title="Permalink"></a></h3><p>Serialization of factors is also discussed in more detail at <a href="../custom_factor_features/#factor_serialization">Standardized Factor Serialization</a>.</p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../basic_definingfactors/">« Custom Prior Factor</a><a class="docs-footer-nextpage" href="../custom_factor_features/">Important Factor Features »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 0.27.15 on <span class="colophon-date" title="Monday 18 April 2022 07:32">Monday 18 April 2022</span>. Using Julia version 1.7.2.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
